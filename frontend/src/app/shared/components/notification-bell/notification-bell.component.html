<p-button
  icon="pi pi-bell"
  [badge]="unreadCount() > 0 ? unreadCount().toString() : undefined"
  badgeClass="p-badge-danger"
  (onClick)="op.toggle($event); loadRecent()"
  [text]="true"
  [rounded]="true"
  severity="secondary"
></p-button>

<p-popover #op [style]="{ width: '400px' }">
  <div class="notification-panel">
    <div class="notification-header">
      <h3 class="text-lg font-semibold mb-0">Notifications</h3>
      @if (unreadCount() > 0) {
      <p-button
        label="Mark all read"
        (onClick)="acknowledgeAll()"
        [text]="true"
        size="small"
      ></p-button>
      }
    </div>

    @if (loading()) {
    <div class="text-center py-4">
      <i class="pi pi-spin pi-spinner text-2xl"></i>
    </div>
    } @else if (recentNotifications().length === 0) {
    <div class="text-center py-8 text-gray-500">
      <i class="pi pi-bell-slash text-4xl mb-2"></i>
      <p>No notifications</p>
    </div>
    } @else {
    <p-scrollPanel [style]="{ width: '100%', height: '400px' }">
      <div class="notification-list">
        @for (notification of recentNotifications(); track notification.id) {
        <div
          class="notification-item"
          [class.unread]="!notification.acknowledged_at"
          (click)="viewAllNotifications()"
        >
          <div class="notification-content">
            <div class="flex items-start justify-between mb-1">
              <p-tag
                [value]="notification.event.severity"
                [severity]="getSeverityClass(notification.event.severity)"
              ></p-tag>
              <span class="text-xs text-gray-500">
                {{ getTimeSince(notification.created_at) }}
              </span>
            </div>
            <p class="notification-description">
              {{ notification.event.description }}
            </p>
            <div class="flex items-center justify-between mt-2">
              <span class="text-xs text-gray-600">
                <i [class]="'pi ' + getChannelIcon(notification.channel)"></i>
                {{ notification.channel }}
              </span>
              @if (!notification.acknowledged_at) {
              <p-button
                label="Mark read"
                (onClick)="acknowledgeNotification(notification, $event)"
                [text]="true"
                size="small"
              ></p-button>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </p-scrollPanel>
    }

    <div class="notification-footer">
      <p-button
        label="View all notifications"
        (onClick)="viewAllNotifications(); op.hide()"
        [outlined]="true"
        severity="secondary"
        styleClass="w-full"
      ></p-button>
    </div>
  </div>
</p-popover>
