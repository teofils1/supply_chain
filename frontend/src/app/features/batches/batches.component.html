<div class="flex flex-col gap-4">
  <!-- Header with Create Button -->
  <div class="flex justify-between items-center">
    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">
      {{ "pages.batches.title" | translate }}
    </h2>
    <p-button
      label="Create Batch"
      icon="pi pi-plus"
      (onClick)="createBatch()"
      class="p-button-primary"
    ></p-button>
  </div>

  <!-- Filters Card -->
  <p-card>
    <ng-template pTemplate="header">
      <h3 class="text-lg font-medium">Filters</h3>
    </ng-template>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
      <!-- Search -->
      <div class="flex flex-col">
        <div class="flex">
          <label class="text-sm font-medium mb-2">Search</label>
          <i class="pi pi-search ml-2"></i>
        </div>
        <span class="p-input-icon-left">
          <input
            type="text"
            pInputText
            placeholder="Search batches..."
            [ngModel]="searchTerm()"
            (ngModelChange)="searchTerm.set($event)"
            (keyup.enter)="onSearch()"
            class="w-full"
          />
        </span>
      </div>

      <!-- Product Filter -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">Product</label>
        <p-select
          [options]="products()"
          optionLabel="name"
          optionValue="id"
          placeholder="All Products"
          [ngModel]="selectedProduct()"
          (ngModelChange)="selectedProduct.set($event); onProductFilter()"
          [showClear]="true"
          class="w-full"
        ></p-select>
      </div>

      <!-- Status Filter -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">Status</label>
        <p-select
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Statuses"
          [ngModel]="selectedStatus()"
          (ngModelChange)="selectedStatus.set($event); onStatusFilter()"
          [showClear]="true"
          class="w-full"
        ></p-select>
      </div>

      <!-- Expiry Status Filter -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">Expiry Status</label>
        <p-select
          [options]="expiryStatusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All"
          [ngModel]="selectedExpiryStatus()"
          (ngModelChange)="
            selectedExpiryStatus.set($event); onExpiryStatusFilter()
          "
          [showClear]="true"
          class="w-full"
        ></p-select>
      </div>

      <!-- Actions -->
      <div class="flex flex-col justify-end">
        <div class="flex gap-2">
          <p-button
            label="Search"
            icon="pi pi-search"
            (onClick)="onSearch()"
            class="p-button-primary"
          ></p-button>
          <p-button
            label="Clear"
            icon="pi pi-times"
            (onClick)="clearFilters()"
            class="p-button-secondary"
          ></p-button>
        </div>
      </div>
    </div>

    <!-- Date Range Filters -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">Expiry Date Range</label>
        <div class="flex gap-2">
          <p-datepicker
            [ngModel]="expiryFromDate()"
            (ngModelChange)="expiryFromDate.set($event); onExpiryDateFilter()"
            placeholder="From"
            dateFormat="yy-mm-dd"
            iconDisplay="input"
          ></p-datepicker>
          <p-datepicker
            [ngModel]="expiryToDate()"
            (ngModelChange)="expiryToDate.set($event); onExpiryDateFilter()"
            placeholder="To"
            dateFormat="yy-mm-dd"
            iconDisplay="input"
          ></p-datepicker>
        </div>
      </div>
    </div>
  </p-card>

  <!-- Batches Table -->
  <p-card>
    <p-table
      [value]="batches()"
      [loading]="loading()"
      [lazy]="true"
      [paginator]="true"
      [rows]="rows()"
      [first]="first()"
      [totalRecords]="totalRecords()"
      size="small"
      [rowsPerPageOptions]="rowsPerPageOptions"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} batches"
      (onLazyLoad)="onLazyLoad($event)"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="lot_number">
            Lot Number <p-sortIcon field="lot_number"></p-sortIcon>
          </th>
          <th pSortableColumn="product_name">
            Product <p-sortIcon field="product_name"></p-sortIcon>
          </th>
          <th pSortableColumn="manufacturing_date">
            Mfg Date <p-sortIcon field="manufacturing_date"></p-sortIcon>
          </th>
          <th pSortableColumn="expiry_date">
            Expiry Date <p-sortIcon field="expiry_date"></p-sortIcon>
          </th>
          <th>Expiry Status</th>
          <th pSortableColumn="quantity_produced">
            Quantity <p-sortIcon field="quantity_produced"></p-sortIcon>
          </th>
          <th>Availability</th>
          <th>Location</th>
          <th pSortableColumn="status">
            Status <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th>QC</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-batch>
        <tr>
          <td>
            <span class="font-mono text-sm font-medium">{{
              batch.lot_number
            }}</span>
          </td>
          <td>
            <div>
              <div class="font-medium">{{ batch.product_name }}</div>
              <div class="text-xs text-gray-500">{{ batch.product_gtin }}</div>
            </div>
          </td>
          <td>
            <span class="text-sm">{{
              batch.manufacturing_date | date : "shortDate"
            }}</span>
          </td>
          <td>
            <span class="text-sm">{{
              batch.expiry_date | date : "shortDate"
            }}</span>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <p-tag
                [value]="
                  batch.is_expired
                    ? 'Expired'
                    : batch.days_until_expiry <= 30
                    ? 'Expiring Soon'
                    : 'Active'
                "
                [severity]="getExpiryStatusSeverity(batch)"
                class="text-xs"
              ></p-tag>
              <div class="text-xs text-gray-600">
                {{
                  batch.days_until_expiry > 0
                    ? batch.days_until_expiry + " days"
                    : "Expired " +
                      Math.abs(batch.days_until_expiry) +
                      " days ago"
                }}
              </div>
              <p-progressBar
                [value]="batch.shelf_life_remaining_percent"
                [showValue]="false"
                class="h-2"
                [class]="
                  batch.shelf_life_remaining_percent > 50
                    ? 'text-green-500'
                    : batch.shelf_life_remaining_percent > 20
                    ? 'text-yellow-500'
                    : 'text-red-500'
                "
              ></p-progressBar>
            </div>
          </td>
          <td>
            <div class="flex flex-col">
              <span class="text-sm font-medium">{{
                batch.quantity_produced | number
              }}</span>
              <span class="text-xs text-gray-500">Produced</span>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-green-600">{{
                  batch.available_quantity | number
                }}</span>
                <span class="text-xs text-gray-500">available</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">{{
                  batch.quantity_used | number
                }}</span>
                <span class="text-xs text-gray-500">used</span>
              </div>
              <p-progressBar
                [value]="
                  (batch.available_quantity / batch.quantity_produced) * 100
                "
                [showValue]="false"
                class="h-2"
                [class]="
                  batch.available_quantity / batch.quantity_produced > 0.5
                    ? 'text-green-500'
                    : batch.available_quantity / batch.quantity_produced > 0.2
                    ? 'text-yellow-500'
                    : 'text-red-500'
                "
              ></p-progressBar>
            </div>
          </td>
          <td>
            <span class="text-sm">{{
              batch.manufacturing_location || "-"
            }}</span>
          </td>
          <td>
            <p-tag
              [value]="batch.status"
              [severity]="getStatusSeverity(batch.status)"
              class="capitalize"
            ></p-tag>
          </td>
          <td>
            <i
              [class]="
                batch.quality_control_passed
                  ? 'pi pi-check-circle text-green-500'
                  : 'pi pi-times-circle text-red-500'
              "
              [pTooltip]="
                batch.quality_control_passed ? 'QC Passed' : 'QC Failed'
              "
            ></i>
          </td>
          <td>
            <div class="flex">
              <p-button
                icon="pi pi-eye"
                class="p-button-text p-button-sm"
                pTooltip="View"
                (onClick)="viewBatch(batch)"
              ></p-button>
              <p-button
                icon="pi pi-pencil"
                class="p-button-text p-button-sm"
                pTooltip="Edit"
                (onClick)="editBatch(batch)"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                class="p-button-text p-button-sm p-button-danger"
                pTooltip="Delete"
                (onClick)="deleteBatch(batch)"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="11" class="text-center py-8">
            <div class="flex flex-col items-center gap-4">
              <i class="pi pi-calendar text-4xl text-gray-400"></i>
              <div>
                <p class="text-lg font-medium text-gray-600">
                  No batches found
                </p>
                <p class="text-sm text-gray-500">
                  Try adjusting your search criteria or create a new batch.
                </p>
              </div>
              <p-button
                label="Create First Batch"
                icon="pi pi-plus"
                (onClick)="createBatch()"
                class="p-button-primary"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Toast for notifications -->
<p-toast></p-toast>

<!-- Confirmation dialog -->
<p-confirmDialog></p-confirmDialog>
