<div class="flex flex-col gap-4">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="flex justify-between items-center flex-wrap gap-4">
    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">
      {{ "pages.documents.title" | translate }}
    </h2>
    <p-button
      label="{{ 'pages.documents.upload' | translate }}"
      icon="pi pi-upload"
      (onClick)="openUploadDialog()"
    ></p-button>
  </div>

  <!-- Filters -->
  <p-card>
    <div class="flex flex-wrap gap-4 items-end">
      <!-- Search -->
      <div class="flex flex-col flex-1 min-w-[200px]">
        <label class="text-sm font-medium mb-2">{{
          "pages.documents.search" | translate
        }}</label>
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()"
            placeholder="{{ 'pages.documents.searchPlaceholder' | translate }}"
            class="w-full"
          />
        </span>
      </div>

      <!-- Category Filter -->
      <div class="flex flex-col min-w-[180px]">
        <label class="text-sm font-medium mb-2">{{
          "pages.documents.category" | translate
        }}</label>
        <p-select
          [options]="categoryOptions"
          [(ngModel)]="selectedCategory"
          (onChange)="onFilterChange()"
          placeholder="All Categories"
          [showClear]="true"
          optionLabel="label"
          optionValue="value"
        ></p-select>
      </div>

      <!-- Entity Type Filter -->
      <div class="flex flex-col min-w-[150px]">
        <label class="text-sm font-medium mb-2">{{
          "pages.documents.entityType" | translate
        }}</label>
        <p-select
          [options]="entityTypeOptions"
          [(ngModel)]="selectedEntityType"
          (onChange)="onFilterChange()"
          placeholder="All Types"
          [showClear]="true"
          optionLabel="label"
          optionValue="value"
        ></p-select>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-2">
        <p-button
          icon="pi pi-search"
          (onClick)="onSearch()"
          pTooltip="Search"
        ></p-button>
        <p-button
          icon="pi pi-filter-slash"
          severity="secondary"
          (onClick)="clearFilters()"
          pTooltip="Clear Filters"
        ></p-button>
      </div>
    </div>
  </p-card>

  <!-- Documents Table -->
  <p-card>
    <p-table
      [value]="documents()"
      [loading]="loading()"
      [paginator]="true"
      [rows]="rows"
      [totalRecords]="totalRecords()"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [first]="first"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} documents"
      styleClass="p-datatable-sm"
      [tableStyle]="{ 'min-width': '60rem' }"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem"></th>
          <th pSortableColumn="title">
            {{ "pages.documents.fields.title" | translate }}
          </th>
          <th pSortableColumn="category">
            {{ "pages.documents.fields.category" | translate }}
          </th>
          <th>{{ "pages.documents.fields.entity" | translate }}</th>
          <th pSortableColumn="file_size">
            {{ "pages.documents.fields.size" | translate }}
          </th>
          <th pSortableColumn="version_number">
            {{ "pages.documents.fields.version" | translate }}
          </th>
          <th>{{ "pages.documents.fields.uploadedBy" | translate }}</th>
          <th pSortableColumn="created_at">
            {{ "pages.documents.fields.uploadedAt" | translate }}
          </th>
          <th style="width: 10rem">
            {{ "pages.documents.fields.actions" | translate }}
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-doc>
        <tr>
          <!-- File Icon -->
          <td>
            <i [class]="getFileIcon(doc.file_type)" class="text-xl"></i>
          </td>

          <!-- Title -->
          <td>
            <div class="flex flex-col">
              <span class="font-medium">{{ doc.title }}</span>
              <span class="text-sm text-gray-500">{{ doc.file_name }}</span>
            </div>
          </td>

          <!-- Category -->
          <td>
            <p-tag
              [value]="getCategoryLabel(doc.category)"
              [severity]="getCategorySeverity(doc.category)"
            ></p-tag>
          </td>

          <!-- Entity -->
          <td>
            <a
              (click)="navigateToEntity(doc)"
              class="text-blue-600 hover:underline cursor-pointer"
            >
              {{ doc.entity_type | titlecase }} #{{ doc.object_id }}
            </a>
          </td>

          <!-- File Size -->
          <td>{{ formatFileSize(doc.file_size) }}</td>

          <!-- Version -->
          <td>
            <span class="font-mono">v{{ doc.version_number }}</span>
            <i
              *ngIf="doc.is_latest"
              class="pi pi-check-circle text-green-500 ml-2"
              pTooltip="Latest version"
            ></i>
          </td>

          <!-- Uploaded By -->
          <td>{{ doc.uploaded_by_name || "System" }}</td>

          <!-- Uploaded At -->
          <td>{{ doc.created_at | date : "short" }}</td>

          <!-- Actions -->
          <td>
            <div class="flex gap-1">
              <p-button
                icon="pi pi-download"
                [rounded]="true"
                [text]="true"
                severity="info"
                (onClick)="downloadDocument(doc)"
                pTooltip="Download"
              ></p-button>
              <p-button
                icon="pi pi-eye"
                [rounded]="true"
                [text]="true"
                (onClick)="viewDocument(doc)"
                pTooltip="View Details"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                [text]="true"
                severity="danger"
                (onClick)="confirmDelete(doc)"
                pTooltip="Delete"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-8">
            <div class="flex flex-col items-center gap-4">
              <i class="pi pi-folder-open text-4xl text-gray-400"></i>
              <p class="text-gray-500">
                {{ "pages.documents.noResults" | translate }}
              </p>
              <p-button
                label="{{ 'pages.documents.uploadFirst' | translate }}"
                icon="pi pi-upload"
                (onClick)="openUploadDialog()"
              ></p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Upload Dialog -->
  <p-dialog
    header="{{ 'pages.documents.uploadDocument' | translate }}"
    [(visible)]="showUploadDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <div class="flex flex-col gap-4">
      <!-- File Upload -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">
          {{ "pages.documents.fields.file" | translate }}
          <span class="text-red-500">*</span>
        </label>
        <p-fileUpload
          mode="basic"
          [auto]="false"
          chooseLabel="Choose File"
          (onSelect)="onFileSelect($event)"
          [maxFileSize]="52428800"
          accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx,.csv,.txt"
        ></p-fileUpload>
        <small *ngIf="uploadFile()" class="text-green-600 mt-1">
          <i class="pi pi-check mr-1"></i>{{ uploadFile()?.name }}
        </small>
      </div>

      <!-- Title -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">
          {{ "pages.documents.fields.title" | translate }}
          <span class="text-red-500">*</span>
        </label>
        <input
          type="text"
          pInputText
          [(ngModel)]="uploadTitle"
          placeholder="Document title"
        />
      </div>

      <!-- Description -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">{{
          "pages.documents.fields.description" | translate
        }}</label>
        <textarea
          pTextarea
          [(ngModel)]="uploadDescription"
          rows="3"
          placeholder="Optional description"
        ></textarea>
      </div>

      <!-- Category -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">{{
          "pages.documents.fields.category" | translate
        }}</label>
        <p-select
          [options]="categoryOptions"
          [(ngModel)]="uploadCategory"
          optionLabel="label"
          optionValue="value"
        ></p-select>
      </div>

      <!-- Entity Type -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">
          {{ "pages.documents.entityType" | translate }}
          <span class="text-red-500">*</span>
        </label>
        <p-select
          [options]="entityTypeOptions"
          [(ngModel)]="uploadEntityType"
          optionLabel="label"
          optionValue="value"
        ></p-select>
      </div>

      <!-- Entity ID -->
      <div class="flex flex-col">
        <label class="text-sm font-medium mb-2">
          {{ "pages.documents.entityId" | translate }}
          <span class="text-red-500">*</span>
        </label>
        <input
          type="number"
          pInputText
          [(ngModel)]="uploadEntityId"
          placeholder="Enter ID of the entity"
        />
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="showUploadDialog.set(false)"
      ></p-button>
      <p-button
        label="Upload"
        icon="pi pi-upload"
        (onClick)="uploadDocument()"
        [loading]="uploading()"
        [disabled]="!uploadFile() || !uploadTitle() || !uploadEntityId()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>
