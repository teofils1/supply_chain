<div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-semibold">User Management</h2>
  <button
    pButton
    label="Add User"
    icon="pi pi-user-plus"
    (click)="openAdd()"
    class="p-button-success"
  ></button>
</div>

<p-table [value]="users()" dataKey="id" class="text-sm" selectionMode="single">
  <ng-template pTemplate="header">
    <tr>
      <th>Username</th>
      <th>Name</th>
      <th>Email</th>
      <th>Active Role</th>
      <th>All Roles</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-user>
    <tr class="hover:bg-surface-100 dark:hover:bg-surface-800">
      <td class="font-mono cursor-pointer" (click)="rowClick(user)">
        {{ user.username }}
      </td>
      <td class="cursor-pointer" (click)="rowClick(user)">
        {{
          (user.first_name || "") + (user.last_name ? " " + user.last_name : "")
        }}
      </td>
      <td class="cursor-pointer" (click)="rowClick(user)">{{ user.email }}</td>
      <td class="cursor-pointer" (click)="rowClick(user)">
        <p-tag
          [value]="user.active_role"
          [severity]="
            user.active_role === 'Admin'
              ? 'danger'
              : user.active_role === 'Operator'
              ? 'info'
              : 'warning'
          "
        ></p-tag>
      </td>
      <td class="cursor-pointer" (click)="rowClick(user)">
        <div class="flex flex-wrap gap-1">
          <p-chip *ngFor="let r of user.roles" [label]="r"></p-chip>
        </div>
      </td>
      <td class="cursor-pointer" (click)="rowClick(user)">
        {{ user.created_at | date : "short" }}
      </td>
      <td>
        <div class="flex gap-1">
          <button
            pButton
            icon="pi pi-pencil"
            severity="secondary"
            size="small"
            (click)="rowClick(user)"
            [pTooltip]="'Edit user'"
          ></button>
          <button
            pButton
            icon="pi pi-trash"
            severity="danger"
            size="small"
            (click)="confirmDelete(user)"
            [pTooltip]="'Delete user'"
          ></button>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Add User Dialog -->
<p-dialog
  header="Add User"
  [visible]="displayAdd()"
  (visibleChange)="displayAdd.set($event)"
  [modal]="true"
  [style]="{ width: '30rem' }"
  (onHide)="displayAdd.set(false)"
>
  <form
    class="flex flex-col gap-4"
    (ngSubmit)="submitAdd()"
    [formGroup]="addForm"
  >
    <div>
      <label class="block text-sm font-medium mb-1">Username *</label>
      <input
        pInputText
        type="text"
        formControlName="username"
        placeholder="username"
        class="w-full"
      />
      <small
        class="text-red-500"
        *ngIf="
          addForm.controls.username.invalid && addForm.controls.username.touched
        "
        >Required (min 3)</small
      >
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">First Name *</label>
      <input
        pInputText
        type="text"
        formControlName="first_name"
        placeholder="First name"
        class="w-full"
      />
      <small
        class="text-red-500"
        *ngIf="
          addForm.controls.first_name.invalid &&
          addForm.controls.first_name.touched
        "
        >Required (min 2)</small
      >
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Last Name</label>
      <input
        pInputText
        type="text"
        formControlName="last_name"
        placeholder="Last name"
        class="w-full"
      />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Email *</label>
      <input
        pInputText
        type="email"
        formControlName="email"
        placeholder="user@example.com"
        class="w-full"
      />
      <small
        class="text-red-500"
        *ngIf="addForm.controls.email.invalid && addForm.controls.email.touched"
        >Valid email required</small
      >
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Initial Role *</label>
      <select
        formControlName="initialRole"
        class="w-full p-2 rounded border border-surface-300 dark:border-surface-700 bg-surface-0 dark:bg-surface-900"
      >
        <option value="" disabled>Select role</option>
        <option *ngFor="let r of roles" [ngValue]="r">{{ r }}</option>
      </select>
      <small
        class="text-red-500"
        *ngIf="
          addForm.controls.initialRole.invalid &&
          addForm.controls.initialRole.touched
        "
        >Select a role</small
      >
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button
        pButton
        type="button"
        label="Cancel"
        severity="secondary"
        (click)="displayAdd.set(false)"
      ></button>
      <button
        pButton
        type="submit"
        label="Create"
        [disabled]="addDisabled"
        icon="pi pi-check"
      ></button>
    </div>
  </form>
</p-dialog>

<!-- Edit User Dialog -->
<p-dialog
  header="Edit User"
  [visible]="displayEdit()"
  (visibleChange)="displayEdit.set($event)"
  [modal]="true"
  [style]="{ width: '34rem' }"
  (onHide)="displayEdit.set(false)"
>
  <ng-container *ngIf="editingUser() as user">
    <form
      class="flex flex-col gap-4"
      (ngSubmit)="submitEdit()"
      [formGroup]="editForm"
    >
      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-1">
          <label class="block text-sm font-medium mb-1">Username</label>
          <input
            pInputText
            type="text"
            [value]="user.username"
            disabled
            class="w-full bg-surface-100 dark:bg-surface-900"
          />
        </div>
        <div class="col-span-1">
          <label class="block text-sm font-medium mb-1">Active Role *</label>
          <select
            formControlName="active_role"
            class="w-full p-2 rounded border border-surface-300 dark:border-surface-700 bg-surface-0 dark:bg-surface-900"
          >
            <option *ngFor="let r of roles" [ngValue]="r">{{ r }}</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">First Name *</label>
        <input
          pInputText
          type="text"
          formControlName="first_name"
          class="w-full"
        />
        <small
          class="text-red-500"
          *ngIf="
            editForm.controls.first_name.invalid &&
            editForm.controls.first_name.touched
          "
          >Required (min 2)</small
        >
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Last Name</label>
        <input
          pInputText
          type="text"
          formControlName="last_name"
          class="w-full"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Email *</label>
        <input pInputText type="email" formControlName="email" class="w-full" />
        <small
          class="text-red-500"
          *ngIf="
            editForm.controls.email.invalid && editForm.controls.email.touched
          "
          >Valid email required</small
        >
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Roles</label>
        <div class="flex flex-wrap gap-2">
          <button
            type="button"
            *ngFor="let r of roles"
            (click)="toggleRole(r)"
            pButton
            [label]="r"
            [severity]="
              editForm.controls.roles.value.includes(r)
                ? 'success'
                : 'secondary'
            "
            [outlined]="!editForm.controls.roles.value.includes(r)"
            [icon]="
              editForm.controls.roles.value.includes(r) ? 'pi pi-check' : ''
            "
          ></button>
        </div>
        <small class="text-xs text-muted-color"
          >Click to add/remove roles. Active role cannot be removed.</small
        >
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button
          pButton
          type="button"
          label="Close"
          severity="secondary"
          (click)="displayEdit.set(false)"
        ></button>
        <button
          pButton
          type="submit"
          label="Save"
          [disabled]="editDisabled"
          icon="pi pi-save"
        ></button>
      </div>
    </form>
  </ng-container>
</p-dialog>

<!-- Delete Confirmation Dialog -->
<p-dialog
  header="Confirm Delete"
  [visible]="displayDelete()"
  (visibleChange)="displayDelete.set($event)"
  [modal]="true"
  [style]="{ width: '25rem' }"
>
  <ng-container *ngIf="deletingUser() as user">
    <div class="flex items-center gap-3 mb-4">
      <i class="pi pi-exclamation-triangle text-2xl text-orange-500"></i>
      <span>Are you sure you want to delete this user?</span>
    </div>
    <div class="bg-surface-100 p-3 rounded mb-4">
      <div class="font-medium">{{ user.username }}</div>
      <div class="text-sm text-muted-color">{{ user.email }}</div>
    </div>
    <div class="flex justify-end gap-2">
      <button
        pButton
        type="button"
        label="Cancel"
        severity="secondary"
        (click)="displayDelete.set(false)"
      ></button>
      <button
        pButton
        type="button"
        label="Delete"
        severity="danger"
        icon="pi pi-trash"
        (click)="deleteUser()"
      ></button>
    </div>
  </ng-container>
</p-dialog>
